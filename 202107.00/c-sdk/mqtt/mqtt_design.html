<!-- This file provides the custom header for Doxygen-generated HTML. Per the
Doxygen documentation, this file may need to be regenerated when Doxygen is
updated. -->
<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.8.14"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>
        MQTT: Design
    </title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="foobar.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
    <div id="titlearea">
    <table cellspacing="0" cellpadding="0">
    <tbody>
        <tr style="height: 56px;">
            <td id="projectalign" style="padding-left: 0.5em;">
                <div id="projectname">
                    <span id="csdkprefix">AWS IoT Device SDK C:</span>
                    MQTT
                </div>
                <div id="projectbrief">
                    MQTT 3.1.1 client library
                </div>
            </td>
        </tr>
        <tr>
            <td id="returntomain">
                <a href="../main/index.html">Return to main page &uarr;</a>
            </td>
        </tr>
    </tbody>
    </table>
    </div>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('mqtt_design.html','');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Design </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Architecture behind the MQTT library.</p>
<h1><a class="anchor" id="mqtt_design_operations"></a>
Asynchronous and synchronous operations</h1>
<p>This library provides both asynchronous and synchronous MQTT operations. Asynchronous operation functions end with <b>Async</b>, and their synchronous variants end with <b>Sync</b>.</p>
<p>For example, <a class="el" href="mqtt_function_publishasync.html">IotMqtt_PublishAsync</a> and <a class="el" href="mqtt_function_publishsync.html">IotMqtt_PublishSync</a> are the respective asynchronous and synchronous MQTT PUBLISH functions. The CONNECT and DISCONNECT operations only have synchronous functions.</p>
<p>Asynchronous functions return immediately to the calling thread after allocating appropriate resources. The application thread can then continue executing while the MQTT operation is processed in the background. Once the MQTT operation is complete, the MQTT library will invoke a callback function provided by the application. The function <a class="el" href="mqtt_function_wait.html">IotMqtt_Wait</a> can be used to wait for an asynchronous operation's completion. It can also be used to cancel asynchronous operations if passed a timeout of <code>0</code>.</p>
<p>Synchronous functions block their calling thread until the MQTT operation is complete. Synchronous functions take a timeout parameter; if the operation does not complete within this timeout, the function returns <a class="el" href="group__mqtt__datatypes__enums.html#gga47b87de32b8c83c88d68e9b9c26d1346ad82bd763f70681413ad415be410f71cd">IOT_MQTT_TIMEOUT</a> and cancels the operation. Synchronous operations do not use a callback; they return a value that represents the result of the operation to the calling thread.</p>
<h1><a class="anchor" id="mqtt_design_asyncoperation"></a>
Operation diagram</h1>
<p>The following diagram shows the workflow of an operation.</p>
<p>MQTT relies on the <a class="elRef" doxygen="/home/ubuntu/Repos/aws-iot-device-sdk-embedded-C/doc/tag/taskpool.tag:../taskpool/" href="../taskpool/index.html#taskpool">task pool library</a> to process asynchronous MQTT operations in the background. Each MQTT API <a class="el" href="mqtt_functions.html">function</a> allocates the required resources, then schedules a background task to send the MQTT packet and receive the server's response. Incoming responses are received through a <a class="elRef" doxygen="/home/ubuntu/Repos/aws-iot-device-sdk-embedded-C/doc/tag/platform.tag:../platform/" href="../platform/platform_network_function_receivecallback.html">network receive callback</a>, which schedules another job to process the response.</p>
<p>Synchronous operations are implemented as a call to the corresponding asynchronous operation. The synchronous function then waits on a semaphore until it receives a notification of completion. The workflow of a synchronous operation is otherwise identical to an asynchronous operation.</p>
<p>Some operations, such as QoS 1 PUBLISHes, may be retried. See <a class="el" href="structIotMqttPublishInfo__t.html">IotMqttPublishInfo_t</a> for a description of the retry strategy.</p>
<div class="image">
<img src="mqtt_design_typicaloperation.png" alt="mqtt_design_typicaloperation.png" width="80%"/>
</div>
<h1><a class="anchor" id="mqtt_design_subscriptions"></a>
Subscriptions</h1>
<p>This section provides a description of how the library handles subscriptions.</p>
<p>MQTT subscriptions are added with <a class="el" href="mqtt_function_subscribeasync.html">IotMqtt_SubscribeAsync</a> or <a class="el" href="mqtt_function_subscribesync.html">IotMqtt_SubscribeSync</a>; subscriptions are removed with <a class="el" href="mqtt_function_unsubscribesync.html">IotMqtt_UnsubscribeSync</a> or <a class="el" href="mqtt_function_unsubscribeasync.html">IotMqtt_UnsubscribeAsync</a>. Subscriptions are associated with a callback function that will be invoked by the library every time a message matching the associated topic filter is received. For example, if a connection has subscriptions for <code>#</code> (which matches everything) and <code>test</code>, and a message is received on <code>test</code>, the callback functions for both <code>#</code> and <code>test</code> will be invoked. Callbacks are invoked from the context of a background task pool threads. Because incoming messages are asynchronous (may arrive at any time), subscription callbacks are also asynchronous.</p>
<p>This library supports the use of MQTT persistent sessions. Persistent sessions cause the MQTT server to store subscriptions and undelivered messages. When re-establishing a persistent session, the client should set <a class="el" href="structIotMqttConnectInfo__t.html#af8b19dd2558ca1dcda19b4e0e75e477e">IotMqttConnectInfo_t::pPreviousSubscriptions</a> and <a class="el" href="structIotMqttConnectInfo__t.html#a295eddcf48256963cca1b13cf2abf2c7">IotMqttConnectInfo_t::previousSubscriptionCount</a> to restore a list of sessions that were present in the persistent session. Setting these members does not send an MQTT SUBSCRIBE packet to the server, so they may only be used with topics that are active on the server.</p>
<h1><a class="anchor" id="mqtt_design_keepalive"></a>
Periodic keep-alive</h1>
<p>This section provides a description of the workflow of periodic keep-alive.</p>
<p>The MQTT standard specifies a keep-alive mechanism to detect half-open or otherwise unusable network connections. An MQTT client will send periodic ping requests (PINGREQ) to the server if the connection is idle. The MQTT server must respond to ping requests with a ping response (PINGRESP).</p>
<p>The standard does not specify how long the server has to respond to a ping request, noting only a "reasonable amount of time". In this library, the amount of time a server has to respond to a ping request is set with <a class="el" href="mqtt_config.html#IOT_MQTT_RESPONSE_WAIT_MS">IOT_MQTT_RESPONSE_WAIT_MS</a>.</p>
<p>The PINGREQ is allocated with the MQTT connection when it is created. A <code>failure</code> flag is also set to <code>0</code>. For simplicity, the diagram below only shows the portions of MQTT CONNECT relevant for keep-alive.</p>
<p>Once MQTT CONNECT returns to the application, the keep-alive is processed entirely through background tasks. The period of the keep-alive is controlled with <a class="el" href="structIotMqttConnectInfo__t.html#accfc0aa36662cbe90c92eaf65ca67242">IotMqttConnectInfo_t::keepAliveSeconds</a> (represented by <code>keepAliveSec</code> in the diagram below). Every <code>keepAliveSec</code>, the following code is run by a background task in the task pool.</p><ol type="1">
<li>If another MQTT packet was sent within the keep-alive period, don't send the PINGREQ and reschedule for the next keep-alive period. For simplicity, this is not shown in the diagram below.</li>
<li>The <code>failure</code> flag is set to <code>1</code>.</li>
<li>A PINGREQ is sent to the server.</li>
<li>If the connection is alive, the server will respond with a PINGRESP. When the client receives the PINGRESP, it sets <code>failure</code> to <code>0</code>.</li>
<li>After <a class="el" href="mqtt_config.html#IOT_MQTT_RESPONSE_WAIT_MS">IOT_MQTT_RESPONSE_WAIT_MS</a>, the client checks the <code>failure</code> flag. If <code>failure=0</code>, then a PINGRESP was received and the next PINGREQ is scheduled. Otherwise, if <code>failure=1</code>, then no PINGRESP was received and the connection terminates. </li>
</ol>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- This file provides the custom footer for Doxygen-generated HTML. Per the
Doxygen documentation, this file may need to be regenerated when Doxygen is
updated. -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      Generated by
      <a href="http://www.doxygen.org/index.html">
      <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14
    </li>
    <li class="footer">
      Last updated Thu Apr 30 2020
    </li>
    <li class="footer" style="float:left">
        SDK version 4.0.0b1
    </li>
  </ul>
</div>
</body>
</html>
