<!-- This file provides the custom header for Doxygen-generated HTML. Per the
Doxygen documentation, this file may need to be regenerated when Doxygen is
updated. -->
<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.8.14"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>
        Main: Automated Tests
    </title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="foobar.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
    <div id="titlearea">
    <table cellspacing="0" cellpadding="0">
    <tbody>
        <tr style="height: 56px;">
            <td id="projectalign" style="padding-left: 0.5em;">
                <div id="projectname">
                    <span id="csdkprefix">AWS IoT Device SDK C:</span>
                    Main
                </div>
            </td>
        </tr>
        <tr>
            <td id="returntomain">
                <a href="../main/index.html">Return to main page &uarr;</a>
            </td>
        </tr>
    </tbody>
    </table>
    </div>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('guide_developer_automated_tests.html','');});
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Automated Tests </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Guide to this SDK's automated testing setup.</p>
<p>The SDK's GitHub repo relies on the following tools to provide automated testing of commits and pull requests.</p><ul>
<li><a href="https://travis-ci.org/">Travis CI</a> is the primary service used for testing. <br />
 <em>See:</em> <a href="https://travis-ci.org/aws/aws-iot-device-sdk-embedded-C">aws-iot-device-sdk-embedded-C on Travis CI</a></li>
<li><a href="https://codecov.io/">Codecov</a> provides code coverage results. <br />
 <em>See</em>: <a href="https://codecov.io/gh/aws/aws-iot-device-sdk-embedded-C">aws-iot-device-sdk-embedded-C on Codecov</a></li>
</ul>
<p>The following files on the GitHub repo control the automated tests:</p><ul>
<li><code>.travis.yml</code> <br />
 Provides the job matrix to run on Travis CI.</li>
<li><code>scripts/</code> directory <br />
 Shell scripts (<code>sh</code>) that run on Travis CI servers.<ul>
<li>The scripts that test the libraries are named after the library they test. For example, <code>ci_test_mqtt.sh</code> tests the MQTT library.</li>
<li><code>ci_test_doc.sh</code> tests the documentation build. Runs for pull requests only.</li>
<li><code>ci_test_coverage.sh</code> generates and submits coverage results to Codecov. Runs for commits only.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="guide_developer_automated_tests_setup"></a>
Setup</h1>
<p>How to set up the automated testing services.</p>
<p>All of the automated testing services have web interfaces that can be connected to a GitHub account.</p>
<h2><a class="anchor" id="guide_developer_automated_tests_setup_travis"></a>
Travis CI</h2>
<p>How to set up Travis CI.</p>
<p><b>Link to Travis CI:</b> <a href="https://travis-ci.org/">https://travis-ci.org/</a></p>
<ol type="1">
<li>Click <em>Sign in with GitHub</em> in the upper right corner to log in with your GitHub account. On your first login, Travis CI will prompt for GitHub permissions access.</li>
<li>Once signed in, hover over your GitHub account in the upper right corner. Click <em>Settings</em> in the menu that pops up.</li>
<li>On the <em>Settings</em> page, toggle the switch next to your fork of the C SDK to <em>On</em>.</li>
<li>Travis CI is now set up. See <a class="el" href="guide_developer_automated_tests.html#guide_developer_automated_tests_credentials_policy_travis">Setting the credentials on Travis CI</a> for adding commit credentials to Travis CI.</li>
</ol>
<h2><a class="anchor" id="guide_developer_automated_tests_setup_codecov"></a>
Codecov</h2>
<p>How to set up Codecov.</p>
<p><b>Link to Codecov:</b> <a href="https://codecov.io/">https://codecov.io/</a></p>
<ol type="1">
<li>Click <em>Log In</em> in the upper right corner. Then select <em>Log in with GitHub</em> to log in with your GitHub account. On your first login, Codecov will prompt for GitHub permissions access.</li>
<li>Navigate to codecov.io/gh/<b>your GitHub username</b>/aws-iot-device-sdk-embedded-C</li>
<li>Click on <em>Settings</em>, then copy the <em>Repository Upload Token</em> displayed.</li>
<li>Set the Travis CI environment variable <code>CODECOV_TOKEN</code> to the Repository Upload Token. Travis CI will automatically submit coverage data on commit check builds.</li>
</ol>
<h1><a class="anchor" id="guide_developer_automated_tests_commit_pr"></a>
Commit vs. Pull Request</h1>
<p>The automated tests distinguish between GitHub commits and pull requests. Different sets of tests run on commits and pull requests.</p>
<p>Because pull requests come from other repos and contain unknown code, Travis CI will not provide encrypted environment variables for pull requests. Therefore, pull requests are tested against unsecured servers. The following tests are run for pull requests.</p><ul>
<li>Common (<code>ci_test_common.sh</code>): this script tests common components like the task pool, atomics, etc. These tests do not use the network.</li>
<li>MQTT (<code>ci_test_mqtt.sh</code>): the MQTT tests run on an unsecured connection against a locally-installed Mosquitto broker on the Travis CI VM.</li>
<li>Shadow (<code>ci_test_shadow.sh</code>): only the Shadow unit tests are run for a pull request build. These tests do not use the network.</li>
<li>Documentation (<code>ci_test_doc.sh</code>): checks that the documentation builds against the code in the pull request.</li>
</ul>
<p>For commits, the credentials necessary for connecting to AWS IoT are provided by Travis CI. The following tests are run for commits.</p><ul>
<li>Common (<code>ci_test_common.sh</code>): runs the same tests as the common pull request tests.</li>
<li>MQTT (<code>ci_test_mqtt.sh</code>): runs the same MQTT tests as the MQTT pull request tests, but against the AWS IoT MQTT broker instead of a Mosquitto broker.</li>
<li>Shadow (<code>ci_test_shadow.sh</code>): runs both the Shadow unit tests and the Shadow system tests. Requires connection to AWS IoT.</li>
<li>Coverage (<code>ci_test_coverage.sh</code>): Gathers code coverage data and submits it to Codecov.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Rarely, the Shadow tests on a GitHub fork will fail with a <code>429 TOO MANY REQUESTS</code> error. If this happens, restart the Shadow tests. The main C SDK GitHub repo has an increased limit for Shadow requests, so it should not encounter this error.</dd></dl>
<p>Because different sets of tests are run for commits and pull requests, both commit and pull request checks should be used to validate code changes. The commit checks can be set up to run on a GitHub fork, where they will run whenever a new commit is pushed to the fork. When a pull request is made from the fork to the main repo, the pull request checks will run.</p>
<h1><a class="anchor" id="guide_developer_automated_tests_credentials_policy"></a>
AWS Credentials and Policy</h1>
<p>How to set up AWS IoT credentials for commit checks.</p>
<p>Forking the main GitHub repo copies the Travis CI scripts, but does not copy any credentials, which are provided by Travis CI's <a href="https://docs.travis-ci.com/user/environment-variables/">encrypted environment variable</a> feature. AWS IoT credentials are required to run the commit checks. No credentials are required to run pull request checks.</p>
<h2><a class="anchor" id="guide_developer_automated_tests_credentials_policy_formatting"></a>
Formatting the client certificate and private key</h2>
<p>The AWS IoT client certificate and private key must be formatted to be acceptable for use in a CI script.</p>
<p>The credentials are written from Travis encrypted environment variables using the following command: </p><div class="fragment"><div class="line">echo -e $AWS_IOT_CLIENT_CERT &gt; credentials/clientCert.pem</div></div><!-- fragment --><p>Therefore, all given credentials must be formatted for <code>echo -e</code>. As an example, consider the following certificate: </p><div class="fragment"><div class="line">-----BEGIN CERTIFICATE-----</div><div class="line">MIIB8TCCAZugAwIBAwIBADANBgkqhkiG9w0BAQQFADBfMRMwEQYDVQQDEwpuZXRh</div><div class="line">cHAuY29tMQswCQYDVQQGEwJVUzEJMAcGA1UECBMAMQkwBwYDVQQHEwAxCTAHBgNV</div><div class="line">BAoTADEJMAcGA1UECxMAMQ8wDQYJKoZIhvcNAQkBFgAwHhcNMTAwNDI2MTk0OTI4</div><div class="line">WhcNMTAwNTI2MTk0OTI4WjBfMRMwEQYDVQQDEwpuZXRhcHAuY29tMQswCQYDVQQG</div><div class="line">EwJVUzEJMAcGA1UECBMAMQkwBwYDVQQHEwAxCTAHBgNVBAoTADEJMAcGA1UECxMA</div><div class="line">MQ8wDQYJKoZIhvcNAQkBFgAwXDANBgkqhkiG9w0BAQEFAANLADBIAkEAyXrK2sry</div><div class="line">-----END CERTIFICATE-----</div></div><!-- fragment --><p>It should be formatted as follows for Travis CI: </p><div class="fragment"><div class="line">-----BEGIN\ CERTIFICATE-----\\nMIIB8TCCAZugAwIBAwIBADANBgkqhkiG9w0BAQQFADBfMRMwEQYDVQQDEwpuZXRh\\ncHAuY29tMQswCQYDVQQGEwJVUzEJMAcGA1UECBMAMQkwBwYDVQQHEwAxCTAHBgNV\\nBAoTADEJMAcGA1UECxMAMQ8wDQYJKoZIhvcNAQkBFgAwHhcNMTAwNDI2MTk0OTI4\\nWhcNMTAwNTI2MTk0OTI4WjBfMRMwEQYDVQQDEwpuZXRhcHAuY29tMQswCQYDVQQG\\nEwJVUzEJMAcGA1UECBMAMQkwBwYDVQQHEwAxCTAHBgNVBAoTADEJMAcGA1UECxMA\\nMQ8wDQYJKoZIhvcNAQkBFgAwXDANBgkqhkiG9w0BAQEFAANLADBIAkEAyXrK2sry\\n-----END\ CERTIFICATE-----</div></div><!-- fragment --><p>Note the spaces have an escape character <code>\</code> before them, as in <code>-----BEGIN\ CERTIFICATE-----</code>. Line breaks have been removed and replaced with <code>\\n</code>.</p>
<p>Similar formatting should be applied to the matching private key.</p>
<h2><a class="anchor" id="guide_developer_automated_tests_credentials_policy_travis"></a>
Setting the credentials on Travis CI</h2>
<p>The AWS IoT endpoint, client certificate, and client certificate private key are set on Travis CI's "Settings" page.</p>
<p>To edit the credentials, go to the "Settings" page on Travis CI. This is usually <code>&lt;repo URL&gt;/settings</code>; for example, <code><a href="https://travis-ci.org/aws/aws-iot-device-sdk-embedded-C/settings">https://travis-ci.org/aws/aws-iot-device-sdk-embedded-C/settings</a></code> for the main repo. Under "Environment Variables", set the following variables: </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Value  </th><th class="markdownTableHeadNone">Notes   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AWS_IOT_CLIENT_CERT  </td><td class="markdownTableBodyNone"><a class="el" href="guide_developer_automated_tests.html#guide_developer_automated_tests_credentials_policy_formatting">Formatted client certificate</a>  </td><td class="markdownTableBodyNone">The AWS IoT client certificate. <br />
 This value does not need to be hidden in the build log.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">AWS_IOT_ENDPOINT  </td><td class="markdownTableBodyNone"><code>ABCDEFG1234567.iot.&lt;region&gt;.amazonaws.com</code>  </td><td class="markdownTableBodyNone">The AWS IoT endpoint. <br />
 This value does not need to be hidden in the build log.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AWS_IOT_PRIVATE_KEY  </td><td class="markdownTableBodyNone"><a class="el" href="guide_developer_automated_tests.html#guide_developer_automated_tests_credentials_policy_formatting">Formatted private key</a>  </td><td class="markdownTableBodyNone">The private key matching the AWS IoT client certificate. <dl class="section attention"><dt>Attention</dt><dd><b>This value should be hidden in the build log!</b>   </dd></dl>
</td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">IOT_IDENTIFIER_PREFIX  </td><td class="markdownTableBodyNone"><code>CSDKCI</code>  </td><td class="markdownTableBodyNone">This string is prepended to all MQTT client identifiers used by the CI. <br />
 It may be anything, but must match the client identifier in the AWS IoT policy. <br />
 The example policy below uses <code>CSDKCI</code>. <br />
 This value does not need to be hidden in the build log.   </td></tr>
</table>
<h2><a class="anchor" id="guide_developer_automated_tests_credentials_policy_aws"></a>
Setting the AWS IoT policy</h2>
<p>The certificates used with Travis CI must have an appropriate policy attached.</p>
<p>AWS recommends using the most restrictive policy possible. The following policy should be used for the CI. </p><div class="fragment"><div class="line">{</div><div class="line">  &quot;Version&quot;: &quot;2012-10-17&quot;,</div><div class="line">  &quot;Statement&quot;: [</div><div class="line">    {</div><div class="line">      &quot;Effect&quot;: &quot;Allow&quot;,</div><div class="line">      &quot;Action&quot;: &quot;iot:Connect&quot;,</div><div class="line">      &quot;Resource&quot;: [</div><div class="line">        &quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:client/*&quot;</div><div class="line">      ]</div><div class="line">    },</div><div class="line">    {</div><div class="line">      &quot;Effect&quot;: &quot;Allow&quot;,</div><div class="line">      &quot;Action&quot;: [</div><div class="line">        &quot;iot:Publish&quot;,</div><div class="line">        &quot;iot:Receive&quot;</div><div class="line">      ],</div><div class="line">      &quot;Resource&quot;: [</div><div class="line">        &quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topic/${iot:ClientId}/*&quot;,</div><div class="line">        &quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topic/*/LastWillAndTestament&quot;,</div><div class="line">        &quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topic/$aws/things/${iot:ClientId}/shadow/*&quot;,</div><div class="line">        &quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topic/$aws/things/${iot:ClientId}/jobs/*&quot;</div><div class="line">      ]</div><div class="line">    },</div><div class="line">    {</div><div class="line">      &quot;Effect&quot;: &quot;Allow&quot;,</div><div class="line">      &quot;Action&quot;: &quot;iot:Subscribe&quot;,</div><div class="line">      &quot;Resource&quot;: [</div><div class="line">        &quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topicfilter/${iot:ClientId}/*&quot;,</div><div class="line">        &quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topicfilter/*/LastWillAndTestament&quot;,</div><div class="line">        &quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topicfilter/$aws/things/${iot:ClientId}/shadow/*&quot;,</div><div class="line">        &quot;arn:aws:iot:&lt;region&gt;:&lt;account&gt;:topicfilter/$aws/things/${iot:ClientId}/jobs/*&quot;</div><div class="line">      ]</div><div class="line">    }</div><div class="line">  ]</div><div class="line">}</div></div><!-- fragment --><p>This policy only allows the CI to interact with topics that contain a matching client identifier (which is prefixed with the Travis CI variable <code>IOT_IDENTIFIER_PREFIX</code>). A few special topics used by the MQTT tests are also present. The policy will need to be updated if any new topics are used by the tests in the future.</p>
<h1><a class="anchor" id="guide_developer_automated_tests_jobs_and_provisioning"></a>
Additional Travis CI setup for Jobs and Provisioning system tests</h1>
<p>Additional CI settings for running the <a class="elRef" doxygen="/home/ubuntu/Repos/aws-iot-device-sdk-embedded-C/doc/tag/jobs.tag:../jobs/" href="../jobs/jobs_tests.html">Jobs system tests</a> and <a class="elRef" doxygen="/home/ubuntu/Repos/aws-iot-device-sdk-embedded-C/doc/tag/provisioning.tag:../provisioning/" href="../provisioning/provisioning_tests.html">Provisioning system tests</a>.</p>
<p>The Jobs system tests use AWS CLI to create and delete Jobs. Therefore, additional setup is needed in Travis CI.</p>
<dl class="section pre"><dt>Precondition</dt><dd>See <a class="elRef" doxygen="/home/ubuntu/Repos/aws-iot-device-sdk-embedded-C/doc/tag/jobs.tag:../jobs/" href="../jobs/jobs_tests.html#jobs_system_tests_setup">Setting up Jobs system tests</a> first to set up an AWS account for the Jobs system tests. Note that the coverage tests require an additional Thing to be registered (but can reuse the same AWS credentials).</dd></dl>
<p>Under the "Environment Variables" section of the Travis CI "Settings" page, set the following additional environment variables. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Value  </th><th class="markdownTableHeadNone">Notes   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AWS_ACCESS_KEY_ID  </td><td class="markdownTableBodyNone">The AWS access key for the Jobs tests IAM user  </td><td class="markdownTableBodyNone"><dl class="section attention"><dt>Attention</dt><dd><b>This value should be hidden in the build log!</b>   </dd></dl>
</td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">AWS_DEFAULT_REGION  </td><td class="markdownTableBodyNone">The AWS region to use with the Jobs tests  </td><td class="markdownTableBodyNone">Should be the region where the Jobs test Thing is registered. <br />
 This value does not need to be hidden in the build log.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AWS_SECRET_ACCESS_KEY  </td><td class="markdownTableBodyNone">The AWS secret access key for the Jobs tests IAM user  </td><td class="markdownTableBodyNone"><dl class="section attention"><dt>Attention</dt><dd><b>This value should be hidden in the build log!</b>   </dd></dl>
</td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- This file provides the custom footer for Doxygen-generated HTML. Per the
Doxygen documentation, this file may need to be regenerated when Doxygen is
updated. -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      Generated by
      <a href="http://www.doxygen.org/index.html">
      <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14
    </li>
    <li class="footer">
      Last updated Thu Apr 30 2020
    </li>
    <li class="footer" style="float:left">
        SDK version 4.0.0b1
    </li>
  </ul>
</div>
</body>
</html>
