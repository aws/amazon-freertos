<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWS IoT Device SDK C: Building and Running Demos</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="foobar.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Device SDK C
   &#160;<span id="projectnumber">202012.00</span>
   </div>
   <div id="projectbrief">SDK for connecting to AWS IoT from a device using embedded C.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('building.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Building and Running Demos </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Instructions for building and running demos.</p>
<p>The libraries in this SDK are not dependent on any operating systems. However, the demos for the libraries in this SDK are built and tested on a Linux platform. This SDK builds with <a href="https://cmake.org/">CMake</a>, a cross-platform build tool. </p>
<h1><a class="anchor" id="build_prerequisites"></a>
Prerequisites</h1>
<p>Prerequisites needed to run the demos.</p>
<dl class="section pre"><dt>Precondition</dt><dd><ul>
<li>CMake 3.2.0 or later and a C90 compiler.</li>
</ul>
</dd>
<dd>
<ul>
<li>A supported operating system. The ports provided with this repo are expected to work with all recent versions of the following operating systems, although we cannot guarantee the behavior on all systems.<ul>
<li>Linux system with POSIX sockets and timer APIs. (CI tests on Ubuntu 18.04).<br  />
<ul>
<li>On Linux systems, installation of OpenSSL development libraries and header files, <em>version 1.1.0</em> or later, are required. The OpenSSL development libraries are usually called something like <code>libssl-dev</code> or <code>openssl-devel</code> when installed through a package manager.</li>
<li>Although not a part of the C90 standard, stdint.h is required for fixed-width integer types (e.g int32_t).</li>
</ul>
</li>
</ul>
</li>
</ul>
</dd></dl>
<h1><a class="anchor" id="aws_iot_setup"></a>
AWS IoT Account Setup</h1>
<p>Setting up AWS IoT to run demos.</p>
<p>It is required to setup an AWS account and access the AWS IoT Console for running demos and tests. Follow the links to:</p><ul>
<li><a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-console-signin.html">Setup an AWS account</a>.</li>
<li><a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-console-signin.html">Sign-in to the AWS IoT Console</a> after setting up the AWS account.</li>
</ul>
<h1><a class="anchor" id="configuring_mutual_auth_demo"></a>
Configuring the Mutual Auth Demo</h1>
<p>Passing configuration settings to run the mutual auth demo.</p>
<ul>
<li>You can pass the following configuration settings as command line options in order to run the mutual auth demos: <div class="fragment"><div class="line">cmake .. -DAWS_IOT_ENDPOINT=&quot;aws-iot-endpoint&quot; -DROOT_CA_CERT_PATH=&quot;root-ca-path&quot; -DCLIENT_CERT_PATH=&quot;certificate-path&quot; -DCLIENT_PRIVATE_KEY_PATH=&quot;private-key-path&quot;</div>
</div><!-- fragment --></li>
<li>In order to set these configurations manually, edit <code>demo_config.h</code> in <code>demos/mqtt/mqtt_demo_mutual_auth/</code> to <code>#define</code> the following:<ul>
<li>Set <code>AWS_IOT_ENDPOINT</code> to your custom endpoint. This is found on the <em>Settings</em> page of the AWS IoT Console and has a format of <code>ABCDEFG1234567.iot.us-east-2.amazonaws.com</code>.</li>
<li>Set <code>ROOT_CA_CERT_PATH</code> to the path of the root CA certificate downloaded when setting up the device certificate in <a href="https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/main#aws-iot-account-setup">AWS IoT Account Setup</a>.</li>
<li>Set <code>CLIENT_CERT_PATH</code> to the path of the client certificate downloaded when setting up the device certificate in <a href="https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/main#aws-iot-account-setup">AWS IoT Account Setup</a>.</li>
<li>Set <code>CLIENT_PRIVATE_KEY_PATH</code> to the path of the private key downloaded when setting up the device certificate in <a href="https://github.com/aws/aws-iot-device-sdk-embedded-C/tree/main#aws-iot-account-setup">AWS IoT Account Setup</a>.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="configuring_s3_demos"></a>
Configuring the HTTP S3 Demos</h1>
<p>Generating pre-signed URLs and passing configuration settings to run the S3 upload, download, and multi-threaded download demos.</p>
<p>The S3 upload, download, and multi-threaded download demos require user-generated pre-signed URLs to be configured. A python script <code>presigned_url_gen.py</code> (located in <code>demos/http/common/src/</code>) is provided to easily generate pre-signed PUT and GET URLs.</p>
<h2><a class="anchor" id="autotoc_md0"></a>
Using the Pre-signed URL Generator</h2>
<h3><a class="anchor" id="autotoc_md1"></a>
Dependencies</h3>
<ul>
<li>Python 3+</li>
<li>boto3</li>
<li>argparse</li>
</ul>
<h3><a class="anchor" id="autotoc_md2"></a>
Pre-requisites</h3>
<ol>
<li>
<p class="startli">Install the dependencies. </p><div class="fragment"><div class="line">pip install boto3 argparse</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
You will need an AWS Account with S3 access before beginning. You must install and configure the AWS CLI in order to use this script. <div class="fragment"><div class="line">aws configure</div>
</div><!-- fragment --><ul>
<li>For information on AWS S3, please see: <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/Welcome.html">https://docs.aws.amazon.com/AmazonS3/latest/dev/Welcome.html</a></li>
<li>For AWS CLI installation information, please see: <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html</a></li>
<li>For AWS CLI configuration information, please see: <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html</a> </li>
</ul>
</li>
</ol>
<h3><a class="anchor" id="autotoc_md3"></a>
Usage</h3>
<ol>
<li>
<p class="startli">Run presigned_url_gen.py with your S3 <b>bucket-name</b>, S3 <b>object-key</b>, and optionally, your S3 bucket's <b>region-name</b> (if not specified, the region configured in AWS CLI will be used). </p><div class="fragment"><div class="line">python presigned_urls_gen.py --bucket &lt;YOUR BUCKET NAME&gt; --key &lt;YOUR OBJECT KEY&gt; --region &lt;YOUR BUCKET&#39;S REGION NAME&gt;</div>
</div><!-- fragment --><p class="interli">An example expected output: </p><div class="fragment"><div class="line">#define S3_PRESIGNED_GET_URL    &quot;https://aws-s3-endpoint/object-key.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ABABABABABABABABABAB%2F20201027%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20201027T194726Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=SomeHash12345UrlABcdEFgfIjK&quot;</div>
<div class="line"> </div>
<div class="line">#define S3_PRESIGNED_PUT_URL    &quot;https://aws-s3-endpoint/object-key.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ABABABABABABABABABAB%2F20201027%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20201027T194726Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=SomeHash12345UrlLMnmOPqrStUvW&quot;</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Copy and paste the output into <b>demo_config.h</b> for macro <b>S3_PRESIGNED_GET_URL</b> and <b>S3_PRESIGNED_PUT_URL</b>. </p><div class="fragment"><div class="line"><span class="preprocessor">#define S3_PRESIGNED_GET_URL    &quot;https://aws-s3-endpoint/object-key.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ABABABABABABABABABAB%2F20201027%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20201027T194726Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=SomeHash12345UrlABcdEFgfIjK&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define S3_PRESIGNED_PUT_URL    &quot;https://aws-s3-endpoint/object-key.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ABABABABABABABABABAB%2F20201027%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20201027T194726Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=SomeHash12345UrlLMnmOPqrStUvW&quot;</span></div>
</div><!-- fragment --><p class="interli">You may also pass any or all of the following configuration settings as command line options in order to run the demos: </p><div class="fragment"><div class="line">cmake .. -DS3_PRESIGNED_GET_URL=&quot;your-get-url&quot; -DS3_PRESIGNED_PUT_URL=&quot;your-put-url&quot;</div>
</div><!-- fragment --><p class="endli">Note: A pre-signed GET URL is required for all HTTP S3 demos. For upload demos, in addition to the GET URL, a pre-signed PUT URL is also required. </p>
</li>
</ol>
<h3><a class="anchor" id="autotoc_md4"></a>
Parameter Info</h3>
<ul>
<li><code>--bucket</code> : The name of the target S3 bucket used in the demos.</li>
<li><code>--key</code> : The name of the existing object you wish to download (GET), or the name of the object you wish to upload (PUT).</li>
<li><code>--region</code> : The name of the region in which your S3 bucket was created. If this is not passed in, the region configured in AWS CLI (or us-east-1, if not configured) will be used.</li>
</ul>
<h1><a class="anchor" id="configuring_ota_demos"></a>
Configuring the Over-the-air Update (Release Candidate) Demos</h1>
<p>Configurations and Prerequisites for the OTA Demo</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Requirements for OTA demo</h2>
<h3><a class="anchor" id="autotoc_md6"></a>
Prerequisites</h3>
<ol>
<li>
To perform a successful OTA update you would need to complete the prerequisites mentioned here: <a href="https://docs.aws.amazon.com/freertos/latest/userguide/ota-prereqs.html">https://docs.aws.amazon.com/freertos/latest/userguide/ota-prereqs.html</a>  </li>
<li>
A code signing certificate is required to authenticate the update. A code signing certificate based on the SHA-256 ECDSA algorithm will work with the current demos. An example of how to generate this kind of certificate can be found here: <a href="https://docs.aws.amazon.com/freertos/latest/userguide/ota-code-sign-cert-esp.html">https://docs.aws.amazon.com/freertos/latest/userguide/ota-code-sign-cert-esp.html</a>  </li>
</ol>
<h3><a class="anchor" id="autotoc_md7"></a>
Configuration</h3>
<p>You will need to specify the following parameters in the file demo_config.h (located in <code>demos/ota_demo_[mqtt/http]/</code>)</p>
<ol>
<li>
AWS_IOT_ENDPOINT: This is the endpoint for your account. The endpoint should be for the region that your thing was created in. This can be found by going to the AWS IoT Core console, pressing the “Settings” tab on the left hand side of the page. It is under the section labeled “Custom endpoint”.  </li>
<li>
CLIENT_CERT_PATH: This is the client certificate that was downloaded when you created your thing. The path specified needs to be either an absolute path, or a path that is relative to the “cloned-repo-root-dir/build/bin" directory where the demo will be ran from.&lt;/li&gt;
&lt;li&gt; CLIENT_PRIVATE_KEY_PATH: This is the client private key that was downloaded when you created your thing. The path specified needs to be either an absolute path, or a path that is relative to the “cloned-repo-root-dir/build/bin" directory where the demo will be ran from. </li>
<li>
CLIENT_IDENTIFIER: This is the name of the thing you created during the OTA Prerequisites section. </li>
</ol>
<p>An example expected output: </p><div class="fragment"><div class="line">#define AWS_IOT_ENDPOINT           &quot;endpoint##-ats.iot.us-west-2.amazonaws.com&quot;</div>
<div class="line">#define CLIENT_CERT_PATH           &quot;/home/ubuntu/certificates/thing#-certificate.pem.crt&quot;</div>
<div class="line">#define CLIENT_PRIVATE_KEY_PATH    &quot;/home/ubuntu/certificates/thing#-private.pem.key&quot;</div>
<div class="line">#define CLIENT_IDENTIFIER          &quot;testclient&quot;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md8"></a>
Scheduling an OTA Update Job</h3>
<p>After you build and run the initial executable you will have to create another executable and schedule an OTA update job with this image. </p><ol>
<li>
Increase the version of the application by setting macro <code>APP_VERSION_BUILD</code> in demos/ota_demo_core_[mqtt/http]/demo_config.h to a different version than what is running. </li>
<li>
Rebuild the application using <a class="el" href="building.html#building_demo_commmandline">Build Steps</a> from below into a different directory, say build-dir-2 </li>
<li>
Rename the demo executable to reflect the change, e.g. <code>mv ota_demo_core_mqtt ota_demo_core_mqtt2</code> </li>
<li>
Create an OTA job: <ol>
<li>
Go to the AWS IoT Core console console.aws.amazon.com/iot/ (<a href="http://console.aws.amazon.com/iot/">http://console.aws.amazon.com/iot/</a>) </li>
<li>
Manage → Jobs → Create → Create a FreeRTOS OTA update job → Select <code>testclient</code> from the thing list </li>
<li>
Sign a new firmware → Create a new profile → Select any SHA-ECDSA signing platform → Upload the code signing certificate(from prerequisites) and provide its path on the device. </li>
<li>
Select the image → Select the bucket you created in prerequisites → Upload the binary build-dir-2/bin/ota_demo2 </li>
<li>
The path on device should be the complete path to place the executable and the binary name: eg /home/ubuntu/aws-iot-device-sdk-embedded-C-staging/build-dir/bin/ota_demo_core_mqtt2 </li>
<li>
Select the IAM role created in prerequisites </li>
<li>
Create the Job </li>
</ol>
</li>
<li>
Run the initial executable again with the following command: <code>sudo ./ota_demo_core_mqtt or sudo ./ota_demo_core_http</code> </li>
</ol>
<h1><a class="anchor" id="building_demo_commmandline"></a>
Build Steps</h1>
<p>How to build the demo applications on the command-line.</p>
<ul>
<li>While in the root directory of AWS IoT Device SDK C, create a build directory, then change to that build directory. <div class="fragment"><div class="line">mkdir build &amp;&amp; cd build</div>
</div><!-- fragment --></li>
<li>Run cmake while inside build directory. <div class="fragment"><div class="line">cmake ..</div>
</div><!-- fragment --></li>
<li>Run this command to build the demos. <div class="fragment"><div class="line">make</div>
</div><!-- fragment --></li>
</ul>
<p>All demo executables can now be found in the <code>build/bin</code> directory and should be run while inside that directory.</p>
<h2><a class="anchor" id="docker_containers_for_demos"></a>
Installing Docker Containers for Demos</h2>
<p>Alternative option of using Docker containers for running demos locally.</p>
<p>Install Docker:</p>
<div class="fragment"><div class="line">curl -fsSL https://get.docker.com -o get-docker.sh</div>
<div class="line"> </div>
<div class="line">sh get-docker.sh</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md9"></a>
Installing Mosquitto Broker to run MQTT demos locally</h4>
<p>The following instructions have been tested on an Ubuntu 18.04 environment with Docker and OpenSSL installed. </p><ol>
<li>
<p class="startli">Download the official Docker image for Mosquitto.</p>
<div class="fragment"><div class="line">docker pull eclipse-mosquitto:latest</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli"><code>BROKER_ENDPOINT</code> defined in <code>demos/mqtt/mqtt_demo_basic_tls/demo_config.h</code> can now be set to <code>localhost</code>.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">For TLS communication with Mosquitto broker, server and CA credentials need to be created. Use OpenSSL commands to generate the credentials for the Mosquitto server.</p>
<ul>
<li>Generate CA key and certificate. Provide the Subject field information as appropriate. <div class="fragment"><div class="line">openssl req -x509 -nodes -sha256 -days 365 -newkey rsa:2048 -keyout ca.key -out ca.crt</div>
</div><!-- fragment --></li>
<li>Generate server key and certificate and sign with the CA cert. <div class="fragment"><div class="line">openssl req -nodes -sha256 -new -keyout server.key -out server.csr</div>
<div class="line"> </div>
<div class="line">openssl x509 -req -sha256 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 365</div>
</div><!-- fragment --></li>
</ul>
<p class="endli"></p>
</li>
<li>
<p class="startli">Create a mosquitto.conf file to use port 8883 (for TLS communication) and providing path to the generated credentials.</p>
<div class="fragment"><div class="line">port 8883</div>
<div class="line"> </div>
<div class="line">cafile /mosquitto/config/ca.crt</div>
<div class="line">certfile /mosquitto/config/server.crt</div>
<div class="line">keyfile /mosquitto/config/server.key</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Use this option for TLS mutual authentication (where client will provide CA signed certificate)</span></div>
<div class="line"><span class="preprocessor">#require_certificate true</span></div>
<div class="line">tls_version tlsv1.2</div>
<div class="line">#use_identity_as_username <span class="keyword">true</span></div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
<p class="startli">Run the docker container from the local directory containing the generated credential and mosquitto.conf files.</p>
<div class="fragment"><div class="line">docker run -it -p 8883:8883 -v $(pwd):/mosquitto/config/ --name mosquitto-basic-tls eclipse-mosquitto:latest</div>
</div><!-- fragment --><p class="endli"></p>
</li>
<li>
Set <code>ROOT_CA_CERT_PATH</code> to the absolute path of the CA certificate created in step 3. for the local Mosquitto server. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
