<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWS IoT Over-the-air Update: Design</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="foobar.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Over-the-air Update<span id="projectnumber">&#160;v3.0.0</span>
   </div>
   <div id="projectbrief">Client library for AWS IoT OTA</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('ota_design.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Design </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Architecture of the OTA library.</p>
<div class="image">
<img src="ota_architecture.png" alt=""/>
</div>
<h1><a class="anchor" id="ota_design_library_configs"></a>
OTA Library Configurations</h1>
<p >The OTA library also provides various configuration options you can fine tune depending on network type and conditions. The library is provided with sensible default values for these configuration options. As these configuration settings are C pre-processor constant, they can be set with a <code>#define</code> in the config file (ota_config.h). It is recommended to review the configuration options and update as per use case and application requirement. Because they are compile-time constants, a library must be rebuilt if a configuration setting is changed.</p>
<p >For more details on OTA configuration at <a class="el" href="ota_config.html">Configurations</a></p>
<h1><a class="anchor" id="ota_design_library"></a>
OTA Library</h1>
<p >The OTA library provides OTA Agent APIs for application development. The OTA library components consists of the OTA Agent task which contains the OTA state machine, AWS Jobs and Streaming service support over MQTT/HTTP protocol. The library defines interfaces for Platform Abstraction Layer (PAL), Operating System, MQTT, and HTTP to enable the user to work with 3rd party libraries and various devices.</p>
<h2><a class="anchor" id="ota_design_agent_api"></a>
OTA Agent API’s</h2>
<p >The OTA Agent APIs provides the programming interface to the application for OTA functionality like configuring the OTA Agent, controlling the OTA process and getting statistics. The implementation supports only one instance of the OTA Agent and attempts to start OTA Agent when it is already running will only reset the statistics.</p>
<h2><a class="anchor" id="ota_design_pal"></a>
OTA Platform Abstraction Layer</h2>
<p >The OTA platform abstraction layer provides APIs for the portable platform specific functionality of the OTA library. This includes the platform specific file storage , certificate storage , crypto verification, bootloader flags and other platform drivers. Example of OTA Pal port is for the FreeRTOS Windows Simulator.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="ota_porting.html#ota_porting_pal">Porting documentation for PAL</a> for more information.</dd></dl>
<h2><a class="anchor" id="ota_design_os"></a>
OTA OS Functional Abstraction</h2>
<p >OTA Library can be ported to run in a variety of embedded C–based environments (e.g. real-time OS, embedded Linux). OTA Library uses queue for managing events in a state machine and timers for enabling timeouts for self test and file download. The memory allocation wrapper functions should be provided with signature similar to the standard c library malloc and free functions.</p>
<div class="image">
<img src="ota_design_os.png" alt=""/>
</div>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="ota_porting.html#ota_porting_os">Porting documentation for OS</a> for more information.</dd></dl>
<h2><a class="anchor" id="ota_design_mqtt"></a>
OTA MQTT interface</h2>
<p >The OTA library can be used with any 3rd party MQTT library. To enable this a set of function pointers for MQTT functionality (Publish, Subscribe and Unsubscribe) are be used within OTA library code. These function pointers are depicted as MQTT Interface.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="ota_porting.html#ota_porting_mqtt">Porting documentation for MQTT</a> for more information.</dd></dl>
<h2><a class="anchor" id="ota_design_http"></a>
OTA HTTP interface</h2>
<p >The OTA library can be used with any 3rd party HTTP library. To enable this a set of function pointers for HTTP functionality (Init, RequestData and DeInit) are be used within OTA library code. These function pointers are depicted as HTTP Interface.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="ota_porting.html#ota_porting_http">Porting documentation for HTTP</a> for more information.</dd></dl>
<h2><a class="anchor" id="ota_design_memory"></a>
OTA Memory Allocation</h2>
<p >OTA Library requires allocation memory for storing the Job and file decoding and download. OTA library uses user buffer provided by OTA Demo for storing data, but if those are not sufficient then OTA library will try to allocate dynamically using the memory abstraction functions defined by the OS Functional layer.</p>
<h2><a class="anchor" id="ota_design_agent_task"></a>
OTA Agent Task</h2>
<p >The OTA Agent task is started when the OTA Library is initialized. The core functionality is implemented in the task as a state machine and can receive internal/external events. Depending on the type of event and the state , event handlers are called which can result in state transitions as defined in the transition table.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="ota_eventprocessingtask_function.html">OTA Agent Task</a> for more information.</dd></dl>
<h1><a class="anchor" id="ota_design_job_parser"></a>
Job Parser</h1>
<p >The OTA Library uses AWS IoT jobs service and has an inbuilt job parsing functionality. AWS IoT Jobs service defines a set of remote operations that are sent to and executed on one or more devices connected to AWS IoT. Example of such operation can be updating the firmware, certificate rotation etc. The jobs service also provide features like job rollout, where you can specify how quickly targets are notified of a pending job execution. This allows to create a staged rollout to better manage updates, reboots, and other operations. Other features like abort, timeout etc are also provided. Some of the important fields that a job document can contain are -</p>
<ol type="1">
<li>Protocol to download the file, ex MQTT, HTTP</li>
<li>File path for the update file to be stored on the device.</li>
<li>File size in bytes</li>
<li>File Id , default is 0</li>
<li>Code signing certificate path on device</li>
<li>Stream Id ( if MQTT protocol is selected for download )</li>
<li>Pre-signed S3 URL ( if HTTP protocol is selected for download )</li>
<li>Code signature</li>
<li>Code signature type</li>
</ol>
<p >More about the AWS IoT Jobs here (<a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-jobs.html">https://docs.aws.amazon.com/iot/latest/developerguide/iot-jobs.html</a>).</p>
<h1><a class="anchor" id="ota_design_control_data_protocols"></a>
OTA Control and Data Protocols</h1>
<p >The OTA Library operations with respect to the AWS IoT Job service can be divided into control ( Job notification, status updates, abort etc.) and data (file download). The current implementation supports MQTT protocol for control as well as data operations. HTTP is supported for data operations only i.e downloading the update file from a pre-signed URL shared in the job document. The file download protocol is selected when creating the OTA job and the OTA configuration on device has preferred protocol in case multiple protocols are selected.</p>
<dl class="section note"><dt>Note</dt><dd>HTTPS will only be used for file download from S3 pre-signed url , for control messages to the AWS cloud service it will use MQTT. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
