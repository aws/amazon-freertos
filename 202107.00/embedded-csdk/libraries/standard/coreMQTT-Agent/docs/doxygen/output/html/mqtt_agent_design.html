<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>coreMQTT Agent: Design</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="foobar.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">coreMQTT Agent<span id="projectnumber">&#160;v1.0.0</span>
   </div>
   <div id="projectbrief">Thread safe MQTT 3.1.1 Client</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('mqtt_agent_design.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Design </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Architecture of the MQTT Agent library.</p>
<h1><a class="anchor" id="mqtt_agent_task_thread_safety"></a>
Thread Safe and Unsafe APIs</h1>
<p >The MQTT Agent APIs are designed to be used by two types of tasks:</p><ul>
<li>An MQTT agent task that manages an MQTT connection and calls coreMQTT APIs. The APIs used by this task are not thread safe, and each agent task should use a unique <a class="el" href="struct_m_q_t_t_agent_context__t.html">MQTTAgentContext_t</a> (multiple agent tasks may be used to handle multiple simultaneous MQTT connections, but each must have a unique context). This task is expected to invoke <a class="el" href="core__mqtt__agent_8h.html#a9dafeb1701b1a0ee897b626a09cfcff7">MQTTAgent_CommandLoop</a> to process commands from other tasks to call coreMQTT APIs. The APIs for this task are:<ul>
<li><a class="el" href="core__mqtt__agent_8h.html#a584863528e72229f35003485f7ee0edd">MQTTAgent_Init</a></li>
<li><a class="el" href="core__mqtt__agent_8h.html#a9dafeb1701b1a0ee897b626a09cfcff7">MQTTAgent_CommandLoop</a></li>
<li><a class="el" href="core__mqtt__agent_8h.html#a75065d6bff5f2d32831f2c74922296fb">MQTTAgent_ResumeSession</a></li>
<li><a class="el" href="core__mqtt__agent_8h.html#a0362d7d3d68628413f01b32ec2ff4ab6">MQTTAgent_CancelAll</a></li>
</ul>
</li>
<li>Application tasks that want to perform MQTT operations with thread safety. These tasks are any task that is <em>not</em> an MQTT agent task. The APIs used by application tasks are thread safe, and send commands that are processed by an MQTT agent task in <a class="el" href="core__mqtt__agent_8h.html#a9dafeb1701b1a0ee897b626a09cfcff7">MQTTAgent_CommandLoop</a>. These APIs can accept several structures used by either the command or completion callback, and these structures MUST remain in scope until the associated command has been completed, including <a class="elRef" href="https://freertos.org/Documentation/api-ref/coreMQTT/docs/doxygen/output/html/struct_m_q_t_t_publish_info__t.html">MQTTPublishInfo_t</a>, <a class="el" href="struct_m_q_t_t_agent_subscribe_args__t.html">MQTTAgentSubscribeArgs_t</a>, <a class="el" href="struct_m_q_t_t_agent_connect_args__t.html">MQTTAgentConnectArgs_t</a>, and <a class="el" href="group__mqtt__agent__struct__types.html#ga953da1618097a29381f3fc38f576055c">MQTTAgentCommandContext_t</a>. The APIs are asynchronous, so will return as soon as the command has been sent; they will <em>not</em> wait for the command to be processed. These APIs are:<ul>
<li><a class="el" href="core__mqtt__agent_8h.html#afea2405ab859324cb241ea47e6a5ab81">MQTTAgent_Publish</a></li>
<li><a class="el" href="core__mqtt__agent_8h.html#a651cf10182392ecea5e8609af8855d49">MQTTAgent_Subscribe</a></li>
<li><a class="el" href="core__mqtt__agent_8h.html#ac3f70c81c8f8947dfb7346045c8edb63">MQTTAgent_Unsubscribe</a></li>
<li><a class="el" href="core__mqtt__agent_8h.html#ae260e29f31d51953cbab2e1437f645ed">MQTTAgent_Ping</a></li>
<li><a class="el" href="core__mqtt__agent_8h.html#a782425e50d258837d23e379471254412">MQTTAgent_Connect</a></li>
<li><a class="el" href="core__mqtt__agent_8h.html#a26687b9b762b5f52b14387bacdf17224">MQTTAgent_Disconnect</a></li>
<li><a class="el" href="core__mqtt__agent_8h.html#ae1b19c10831f72251603b045f2608313">MQTTAgent_Terminate</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="mqtt_agent_interfaces"></a>
Interfaces and Callbacks</h1>
<p >Similar to coreMQTT, the MQTT Agent library relies on interfaces to dissociate itself from platform specific functionality. Interfaces used by the MQTT Agent library are simply function pointers with expectations of behavior.</p>
<p >The MQTT Agent library expects the application to provide implementations for the following interfaces:</p>
<table class="doxtable">
<tr>
<td><b>Function Pointer</b> </td><td><b>Use</b>  </td></tr>
<tr>
<td><a class="el" href="core__mqtt__agent__message__interface_8h.html#ad723bb4fba6cec8bf69c039c0d34a824">MQTTAgentMessageRecv_t</a> </td><td>Receiving commands sent to the agent task.  </td></tr>
<tr>
<td><a class="el" href="core__mqtt__agent__message__interface_8h.html#a253db91729e7d75433785b9f45a4e26e">MQTTAgentMessageSend_t</a> </td><td>Sending commands to the agent task from the application  </td></tr>
<tr>
<td><a class="el" href="core__mqtt__agent__message__interface_8h.html#a61db0a5f8ea9119d86cf7b0c2b4cb8d2">MQTTAgentCommandGet_t</a> </td><td>Allocating storage for a command to be sent to the agent task.  </td></tr>
<tr>
<td><a class="el" href="core__mqtt__agent__message__interface_8h.html#a1acc4e89dd0f33c7fecf24555abc5cc4">MQTTAgentCommandRelease_t</a> </td><td>Releasing a command obtained from <a class="el" href="core__mqtt__agent__message__interface_8h.html#a61db0a5f8ea9119d86cf7b0c2b4cb8d2">MQTTAgentCommandGet_t</a>.  </td></tr>
<tr>
<td><a class="el" href="group__mqtt__agent__callback__types.html#gacdfb8687b1217d321e7cc58e365ec6a1">MQTTAgentIncomingPublishCallback_t</a> </td><td>Accepting incoming publish messages, with the possibility of further distributing them to other tasks.  </td></tr>
</table>
<h1><a class="anchor" id="mqtt_agent_command_completion"></a>
Command Completion</h1>
<p >Commands do not have any timeout associated with them. The only way for a task to be aware of a command's completion is through the invocation of an optional <a class="el" href="group__mqtt__agent__callback__types.html#gaa2497c28b3fb55b8dc38b0873f749eef">MQTTAgentCommandCallback_t</a> completion callback. The completion callback will be invoked with an optional <a class="el" href="group__mqtt__agent__struct__types.html#ga953da1618097a29381f3fc38f576055c">MQTTAgentCommandContext_t</a>, which is the incomplete type <b>struct MQTTAgentCommandContext</b>. This type must be defined by the application, and should contain information that would be useful in distinguishing commands.<br  />
 <b>Example code:</b> </p><div class="fragment"><div class="line"><span class="keyword">struct </span>MQTTAgentCommandContext</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//Allow the calling thread to view the return code by copying it here.</span></div>
<div class="line">    <a class="codeRef" href="https://freertos.org/Documentation/api-ref/coreMQTT/docs/doxygen/output/html/group__mqtt__enum__types.html#gaba7ec045874a1c3432f99173367f735c">MQTTStatus_t</a> returnCode;</div>
<div class="line">    <span class="comment">//pthread mutex and condition variables to signal to the thread that created the command.</span></div>
<div class="line">    pthread_mutex_t lock;</div>
<div class="line">    pthread_cond_t cond;</div>
<div class="line">};</div>
<div class="ttc" id="agroup__mqtt__enum__types_html_gaba7ec045874a1c3432f99173367f735c"><div class="ttname"><a href="https://freertos.org/Documentation/api-ref/coreMQTT/docs/doxygen/output/html/group__mqtt__enum__types.html#gaba7ec045874a1c3432f99173367f735c">MQTTStatus_t</a></div><div class="ttdeci">MQTTStatus_t</div></div>
</div><!-- fragment --><p> <br  />
 The completion callback using such a context could be: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> commandCompleteCallback( <a class="code" href="group__mqtt__agent__struct__types.html#ga953da1618097a29381f3fc38f576055c">MQTTAgentCommandContext_t</a> * pCmdContext, <a class="code" href="struct_m_q_t_t_agent_return_info__t.html">MQTTAgentReturnInfo_t</a> * pReturnInfo )</div>
<div class="line">{</div>
<div class="line">    pthread_mutex_lock( &amp;( pCmdContext-&gt;lock ) );</div>
<div class="line">    <span class="comment">//Set return code so the thread that created the command can view.</span></div>
<div class="line">    pCmdContext-&gt;returnCode = pReturnInfo-&gt;<a class="code" href="struct_m_q_t_t_agent_return_info__t.html#ab04f05e53b8e9039f8983f68b032ccc8">returnCode</a>;</div>
<div class="line">    pthread_mutex_unlock( &amp;( pCmdContext-&gt;lock ) );</div>
<div class="line">    <span class="comment">//Signal the thread using the condition variable.</span></div>
<div class="line">    pthread_cond_broadcast( &amp;( pCmdContext-&gt;cond ) );</div>
<div class="line">}</div>
<div class="ttc" id="agroup__mqtt__agent__struct__types_html_ga953da1618097a29381f3fc38f576055c"><div class="ttname"><a href="group__mqtt__agent__struct__types.html#ga953da1618097a29381f3fc38f576055c">MQTTAgentCommandContext_t</a></div><div class="ttdeci">struct MQTTAgentCommandContext MQTTAgentCommandContext_t</div><div class="ttdoc">Struct containing context for a specific command.</div><div class="ttdef"><b>Definition:</b> core_mqtt_agent.h:109</div></div>
<div class="ttc" id="astruct_m_q_t_t_agent_return_info__t_html"><div class="ttname"><a href="struct_m_q_t_t_agent_return_info__t.html">MQTTAgentReturnInfo_t</a></div><div class="ttdoc">Struct holding return codes and outputs from a command.</div><div class="ttdef"><b>Definition:</b> core_mqtt_agent.h:97</div></div>
<div class="ttc" id="astruct_m_q_t_t_agent_return_info__t_html_ab04f05e53b8e9039f8983f68b032ccc8"><div class="ttname"><a href="struct_m_q_t_t_agent_return_info__t.html#ab04f05e53b8e9039f8983f68b032ccc8">MQTTAgentReturnInfo_t::returnCode</a></div><div class="ttdeci">MQTTStatus_t returnCode</div><div class="ttdef"><b>Definition:</b> core_mqtt_agent.h:98</div></div>
</div><!-- fragment --><p> <br  />
 The completion callback and completion context are each optional, and passed at time of command creation in the <a class="el" href="struct_m_q_t_t_agent_command_info__t.html">MQTTAgentCommandInfo_t</a> parameter. If a command completion context is passed, it MUST remain in scope until the completion callback has been invoked. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
