<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>corePKCS11: C_DigestFinal</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="foobar.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">corePKCS11<span id="projectnumber">&#160;V3.0.0</span>
   </div>
   <div id="projectbrief">PKCS #11 Cryptoki Library</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('pkcs11_mbedtls_function_c_digestfinal.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">C_DigestFinal </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Finishes a multiple-part digesting operation.</p>
<div class="fragment"><div class="line"><a class="code" href="core__pkcs11_8h.html#a30315d302108bcfb354196f37b16a492">CK_DECLARE_FUNCTION</a>( CK_RV, <a class="code" href="core__pkcs11__mbedtls_8c.html#a1f3dc3758726bb4737db956e4cd71e91">C_DigestFinal</a> )( CK_SESSION_HANDLE hSession,</div>
<div class="line">                                             CK_BYTE_PTR pDigest,</div>
<div class="line">                                             CK_ULONG_PTR pulDigestLen )</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="struct_p11_session__t.html">P11Session_t</a> * pxSession = <a class="code" href="core__pkcs11__mbedtls_8c.html#a8a3079aa3ce5d51bb787a3e661714ef0">prvSessionPointerFromHandle</a>( hSession );</div>
<div class="line">    CK_RV xResult = <a class="code" href="core__pkcs11__mbedtls_8c.html#ab93c9263b9b89774e57eee9e8ac708a8">prvCheckValidSessionAndModule</a>( pxSession );</div>
<div class="line">    int32_t lMbedTLSResult = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>( pulDigestLen == NULL )</div>
<div class="line">    {</div>
<div class="line">        LogError( ( <span class="stringliteral">&quot;Failed to finish digest operation. Digest Length pointer &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;was NULL.&quot;</span> ) );</div>
<div class="line">        xResult = CKR_ARGUMENTS_BAD;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>( xResult == CKR_OK )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( pxSession-&gt;<a class="code" href="struct_p11_session__t.html#ae7e701806cc6cc8bf7a08e702faa1365">xOperationDigestMechanism</a> != CKM_SHA256 )</div>
<div class="line">        {</div>
<div class="line">            LogError( ( <span class="stringliteral">&quot;Failed to finish digest operation. Digest operation &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;was not initialized.&quot;</span> ) );</div>
<div class="line">            xResult = CKR_OPERATION_NOT_INITIALIZED;</div>
<div class="line">            pxSession-&gt;<a class="code" href="struct_p11_session__t.html#ae7e701806cc6cc8bf7a08e702faa1365">xOperationDigestMechanism</a> = <a class="code" href="group__pkcs11__macros.html#ga72e760ed32f2b6f0594b8dd809a7a419">pkcs11NO_OPERATION</a>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>( xResult == CKR_OK )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( pDigest == NULL )</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* Supply the required buffer size. */</span></div>
<div class="line">            *pulDigestLen = ( CK_ULONG ) <a class="code" href="core__pkcs11_8h.html#ac1020688685b585cda7b9c4f2b78744f">pkcs11SHA256_DIGEST_LENGTH</a>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>( *pulDigestLen == ( CK_ULONG ) <a class="code" href="core__pkcs11_8h.html#ac1020688685b585cda7b9c4f2b78744f">pkcs11SHA256_DIGEST_LENGTH</a> )</div>
<div class="line">            {</div>
<div class="line">                lMbedTLSResult = mbedtls_sha256_finish_ret( &amp;pxSession-&gt;<a class="code" href="struct_p11_session__t.html#a335416e156facf8dc065d2b1550047da">xSHA256Context</a>, pDigest );</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span>( 0 != lMbedTLSResult )</div>
<div class="line">                {</div>
<div class="line">                    LogError( ( <span class="stringliteral">&quot;Failed to finish digest operation. &quot;</span></div>
<div class="line">                                <span class="stringliteral">&quot;mbedtls_sha256_finish_ret failed: mbed TLS &quot;</span></div>
<div class="line">                                <span class="stringliteral">&quot;error = %s : %s.&quot;</span>,</div>
<div class="line">                                <a class="code" href="core__pkcs11__mbedtls_8c.html#a92427274c3174ef89fbf82a0ad25a252">mbedtlsHighLevelCodeOrDefault</a>( lMbedTLSResult ),</div>
<div class="line">                                <a class="code" href="core__pkcs11__mbedtls_8c.html#a1936e3a07702240561149805e8f0bfbb">mbedtlsLowLevelCodeOrDefault</a>( lMbedTLSResult ) ) );</div>
<div class="line">                    xResult = CKR_FUNCTION_FAILED;</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                pxSession-&gt;<a class="code" href="struct_p11_session__t.html#ae7e701806cc6cc8bf7a08e702faa1365">xOperationDigestMechanism</a> = <a class="code" href="group__pkcs11__macros.html#ga72e760ed32f2b6f0594b8dd809a7a419">pkcs11NO_OPERATION</a>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                LogError( ( <span class="stringliteral">&quot;Failed to finish digest operation. Received a &quot;</span></div>
<div class="line">                            <span class="stringliteral">&quot;buffer that was an unexpected size. Expected %lu and &quot;</span></div>
<div class="line">                            <span class="stringliteral">&quot;received %lu.&quot;</span>,</div>
<div class="line">                            ( <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> ) <a class="code" href="core__pkcs11_8h.html#ac1020688685b585cda7b9c4f2b78744f">pkcs11SHA256_DIGEST_LENGTH</a>,</div>
<div class="line">                            ( <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> ) *pulDigestLen ) );</div>
<div class="line">                xResult = CKR_BUFFER_TOO_SMALL;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>( ( xResult != CKR_OK ) &amp;&amp; ( xResult != CKR_BUFFER_TOO_SMALL ) &amp;&amp;</div>
<div class="line">        ( xResult != CKR_SESSION_HANDLE_INVALID ) &amp;&amp;</div>
<div class="line">        ( xResult != CKR_OPERATION_NOT_INITIALIZED ) )</div>
<div class="line">    {</div>
<div class="line">        LogDebug( ( <span class="stringliteral">&quot;Error occurred, tearing down digest operation.&quot;</span> ) );</div>
<div class="line">        pxSession-&gt;<a class="code" href="struct_p11_session__t.html#ae7e701806cc6cc8bf7a08e702faa1365">xOperationDigestMechanism</a> = <a class="code" href="group__pkcs11__macros.html#ga72e760ed32f2b6f0594b8dd809a7a419">pkcs11NO_OPERATION</a>;</div>
<div class="line">        mbedtls_sha256_free( &amp;pxSession-&gt;<a class="code" href="struct_p11_session__t.html#a335416e156facf8dc065d2b1550047da">xSHA256Context</a> );</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> xResult;</div>
<div class="line">}</div>
<div class="ttc" id="acore__pkcs11_8h_html_a30315d302108bcfb354196f37b16a492"><div class="ttname"><a href="core__pkcs11_8h.html#a30315d302108bcfb354196f37b16a492">CK_DECLARE_FUNCTION</a></div><div class="ttdeci">#define CK_DECLARE_FUNCTION(returnType, name)</div><div class="ttdoc">Macro for defining a PKCS #11 functions.</div><div class="ttdef"><b>Definition:</b> core_pkcs11.h:72</div></div>
<div class="ttc" id="acore__pkcs11_8h_html_ac1020688685b585cda7b9c4f2b78744f"><div class="ttname"><a href="core__pkcs11_8h.html#ac1020688685b585cda7b9c4f2b78744f">pkcs11SHA256_DIGEST_LENGTH</a></div><div class="ttdeci">#define pkcs11SHA256_DIGEST_LENGTH</div><div class="ttdoc">Length of a SHA256 digest, in bytes.</div><div class="ttdef"><b>Definition:</b> core_pkcs11.h:92</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_a1936e3a07702240561149805e8f0bfbb"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#a1936e3a07702240561149805e8f0bfbb">mbedtlsLowLevelCodeOrDefault</a></div><div class="ttdeci">#define mbedtlsLowLevelCodeOrDefault(mbedTlsCode)</div><div class="ttdoc">Utility for converting the level-level code in an mbedTLS error to string, if the code-contains a lev...</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:93</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_a1f3dc3758726bb4737db956e4cd71e91"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#a1f3dc3758726bb4737db956e4cd71e91">C_DigestFinal</a></div><div class="ttdeci">CK_RV C_DigestFinal(CK_SESSION_HANDLE hSession, CK_BYTE_PTR pDigest, CK_ULONG_PTR pulDigestLen)</div><div class="ttdoc">Finishes a multiple-part digesting operation.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:3398</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_a8a3079aa3ce5d51bb787a3e661714ef0"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#a8a3079aa3ce5d51bb787a3e661714ef0">prvSessionPointerFromHandle</a></div><div class="ttdeci">static P11Session_t * prvSessionPointerFromHandle(CK_SESSION_HANDLE xSession)</div><div class="ttdoc">Maps an opaque caller session handle into its internal state structure.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:346</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_a92427274c3174ef89fbf82a0ad25a252"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#a92427274c3174ef89fbf82a0ad25a252">mbedtlsHighLevelCodeOrDefault</a></div><div class="ttdeci">#define mbedtlsHighLevelCodeOrDefault(mbedTlsCode)</div><div class="ttdoc">Utility for converting the high-level code in an mbedTLS error to string, if the code-contains a high...</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:85</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_ab93c9263b9b89774e57eee9e8ac708a8"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#ab93c9263b9b89774e57eee9e8ac708a8">prvCheckValidSessionAndModule</a></div><div class="ttdeci">static CK_RV prvCheckValidSessionAndModule(const P11Session_t *pxSession)</div><div class="ttdoc">Helper to check if the current session is initialized and valid.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:304</div></div>
<div class="ttc" id="agroup__pkcs11__macros_html_ga72e760ed32f2b6f0594b8dd809a7a419"><div class="ttname"><a href="group__pkcs11__macros.html#ga72e760ed32f2b6f0594b8dd809a7a419">pkcs11NO_OPERATION</a></div><div class="ttdeci">#define pkcs11NO_OPERATION</div><div class="ttdoc">Indicates that no PKCS #11 operation is underway for given session.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:109</div></div>
<div class="ttc" id="astruct_p11_session__t_html"><div class="ttname"><a href="struct_p11_session__t.html">P11Session_t</a></div><div class="ttdoc">Session structure.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:271</div></div>
<div class="ttc" id="astruct_p11_session__t_html_a335416e156facf8dc065d2b1550047da"><div class="ttname"><a href="struct_p11_session__t.html#a335416e156facf8dc065d2b1550047da">P11Session_t::xSHA256Context</a></div><div class="ttdeci">mbedtls_sha256_context xSHA256Context</div><div class="ttdoc">Context for in progress digest operation.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:285</div></div>
<div class="ttc" id="astruct_p11_session__t_html_ae7e701806cc6cc8bf7a08e702faa1365"><div class="ttname"><a href="struct_p11_session__t.html#ae7e701806cc6cc8bf7a08e702faa1365">P11Session_t::xOperationDigestMechanism</a></div><div class="ttdeci">CK_MECHANISM_TYPE xOperationDigestMechanism</div><div class="ttdoc">Indicates if a digest operation is in progress.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:274</div></div>
</div><!-- fragment --> <dl class="section see"><dt>See also</dt><dd><a class="el" href="core__pkcs11__mbedtls_8c.html#a3f6bcb9f9be8a7822d9d8f7c44c33403" title="Initializes a message-digesting operation.">C_DigestInit()</a>, <a class="el" href="core__pkcs11__mbedtls_8c.html#a7a8189a6963fbcfdfe2bebe20a8bf3b6" title="Continues a multiple-part digesting operation.">C_DigestUpdate()</a></dd></dl>
<dl class="section note"><dt>Note</dt><dd>Digest parameters are shared by a session. Calling <a class="el" href="core__pkcs11__mbedtls_8c.html#a3f6bcb9f9be8a7822d9d8f7c44c33403" title="Initializes a message-digesting operation.">C_DigestInit()</a>, <a class="el" href="core__pkcs11__mbedtls_8c.html#a7a8189a6963fbcfdfe2bebe20a8bf3b6" title="Continues a multiple-part digesting operation.">C_DigestUpdate()</a>, and <a class="el" href="core__pkcs11__mbedtls_8c.html#a1f3dc3758726bb4737db956e4cd71e91" title="Finishes a multiple-part digesting operation.">C_DigestFinal()</a> with the same session across different tasks may lead to unexpected results.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">hSession</td><td>Handle of a valid PKCS #11 session. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">pDigest</td><td>Pointer to the location that receives the message digest. Memory must be allocated by the caller. Caller is responsible for allocating memory. Providing NULL for this input will cause pulDigestLen to be updated for length of buffer required. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pulDigestLen</td><td>Points to the location that holds the length of the message digest. If pDigest is NULL, this value is updated to contain the length of the buffer needed to hold the digest. Else it is updated to contain the actual length of the digest placed in pDigest.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>CKR_OK if successful. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
