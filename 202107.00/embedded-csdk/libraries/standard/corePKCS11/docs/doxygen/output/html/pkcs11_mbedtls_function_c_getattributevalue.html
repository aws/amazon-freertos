<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>corePKCS11: C_GetAttributeValue</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="foobar.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">corePKCS11<span id="projectnumber">&#160;V3.0.0</span>
   </div>
   <div id="projectbrief">PKCS #11 Cryptoki Library</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('pkcs11_mbedtls_function_c_getattributevalue.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">C_GetAttributeValue </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Obtains an attribute value of an object.</p>
<div class="fragment"><div class="line"><a class="code" href="core__pkcs11_8h.html#a30315d302108bcfb354196f37b16a492">CK_DECLARE_FUNCTION</a>( CK_RV, <a class="code" href="core__pkcs11__mbedtls_8c.html#aaad61dc7b2313286bdd049676ef0fd70">C_GetAttributeValue</a> )( CK_SESSION_HANDLE hSession,</div>
<div class="line">                                                   CK_OBJECT_HANDLE hObject,</div>
<div class="line">                                                   CK_ATTRIBUTE_PTR pTemplate,</div>
<div class="line">                                                   CK_ULONG ulCount )</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* See explanation in prvCheckValidSessionAndModule for this exception. */</span></div>
<div class="line">    <span class="comment">/* coverity[misra_c_2012_rule_10_5_violation] */</span></div>
<div class="line">    CK_BBOOL xIsPrivate = ( CK_BBOOL ) CK_TRUE;</div>
<div class="line">    CK_ULONG iAttrib;</div>
<div class="line">    mbedtls_pk_context xKeyContext = { 0 };</div>
<div class="line">    mbedtls_x509_crt xMbedX509Context = { 0 };</div>
<div class="line">    mbedtls_pk_type_t xKeyType;</div>
<div class="line">    <span class="keyword">const</span> mbedtls_ecp_keypair * pxKeyPair;</div>
<div class="line">    CK_KEY_TYPE xPkcsKeyType = ( CK_KEY_TYPE ) ~0UL;</div>
<div class="line">    CK_OBJECT_CLASS xClass = ~0UL;</div>
<div class="line">    CK_BYTE_PTR pxObjectValue = NULL;</div>
<div class="line">    CK_ULONG ulLength = 0;</div>
<div class="line">    <span class="keyword">const</span> CK_BYTE ucP256Oid[] = <a class="code" href="core__pkcs11_8h.html#a61aab65f40f1865cfcdbb66aab3c9ffa">pkcs11DER_ENCODED_OID_P256</a>;</div>
<div class="line">    int32_t lMbedTLSResult = 0;</div>
<div class="line">    CK_OBJECT_HANDLE xPalHandle = CK_INVALID_HANDLE;</div>
<div class="line">    CK_ULONG xSize = 0;</div>
<div class="line">    <span class="keywordtype">size_t</span> xMbedSize = 0;</div>
<div class="line">    CK_BYTE_PTR pcLabel = NULL;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="struct_p11_session__t.html">P11Session_t</a> * pxSession = <a class="code" href="core__pkcs11__mbedtls_8c.html#a8a3079aa3ce5d51bb787a3e661714ef0">prvSessionPointerFromHandle</a>( hSession );</div>
<div class="line">    CK_RV xResult = <a class="code" href="core__pkcs11__mbedtls_8c.html#ab93c9263b9b89774e57eee9e8ac708a8">prvCheckValidSessionAndModule</a>( pxSession );</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>( ( CKR_OK == xResult ) &amp;&amp; ( ( ( NULL == pTemplate ) ) || ( 0UL == ulCount ) ) )</div>
<div class="line">    {</div>
<div class="line">        LogError( ( <span class="stringliteral">&quot;Failed to get attribute. The template was a NULL pointer &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;or the attribute count was 0.&quot;</span> ) );</div>
<div class="line">        xResult = CKR_ARGUMENTS_BAD;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>( ( CKR_OK == xResult ) &amp;&amp; ( CK_INVALID_HANDLE == hObject ) )</div>
<div class="line">    {</div>
<div class="line">        LogError( ( <span class="stringliteral">&quot;Failed to get attribute. The object handle was invalid.&quot;</span> ) );</div>
<div class="line">        xResult = CKR_OBJECT_HANDLE_INVALID;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>( xResult == CKR_OK )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Copy the object into a buffer.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="core__pkcs11__mbedtls_8c.html#aadf1ee4b99279af65de44082fbd4de52">prvFindObjectInListByHandle</a>( hObject, &amp;xPalHandle, &amp;pcLabel, &amp;xSize ); <span class="comment">/*pcLabel and xSize are ignored. */</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>( xPalHandle != CK_INVALID_HANDLE )</div>
<div class="line">        {</div>
<div class="line">            xResult = <a class="code" href="core__pkcs11__pal_8h.html#a5f9deac2fdf2dc0ac52e87f95d3d6fb6">PKCS11_PAL_GetObjectValue</a>( xPalHandle, &amp;pxObjectValue, &amp;ulLength, &amp;xIsPrivate );</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            LogError( ( <span class="stringliteral">&quot;Failed to get attribute. Could not find a valid &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;PKCS #11 PAL handle.&quot;</span> ) );</div>
<div class="line">            xResult = CKR_OBJECT_HANDLE_INVALID;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Determine what kind of object we are dealing with. */</span></div>
<div class="line">    <span class="keywordflow">if</span>( xResult == CKR_OK )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Initialize mbed TLS key context. */</span></div>
<div class="line">        mbedtls_pk_init( &amp;xKeyContext );</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Initialize mbed TLS x509 context. */</span></div>
<div class="line">        mbedtls_x509_crt_init( &amp;xMbedX509Context );</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span>( 0 == mbedtls_pk_parse_key( &amp;xKeyContext, pxObjectValue, ulLength, NULL, 0 ) )</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* See explanation in prvCheckValidSessionAndModule for this exception. */</span></div>
<div class="line">            <span class="comment">/* coverity[misra_c_2012_rule_10_5_violation] */</span></div>
<div class="line">            <span class="keywordflow">if</span>( xIsPrivate == ( CK_BBOOL ) CK_TRUE )</div>
<div class="line">            {</div>
<div class="line">                LogDebug( ( <span class="stringliteral">&quot;Object was a private key.&quot;</span> ) );</div>
<div class="line">                xClass = CKO_PRIVATE_KEY;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                LogDebug( ( <span class="stringliteral">&quot;Object was a public key.&quot;</span> ) );</div>
<div class="line">                xClass = CKO_PUBLIC_KEY;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( 0 == mbedtls_pk_parse_public_key( &amp;xKeyContext, pxObjectValue, ulLength ) )</div>
<div class="line">        {</div>
<div class="line">            LogDebug( ( <span class="stringliteral">&quot;Object was a public key.&quot;</span> ) );</div>
<div class="line">            xClass = CKO_PUBLIC_KEY;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( 0 == mbedtls_x509_crt_parse( &amp;xMbedX509Context, pxObjectValue, ulLength ) )</div>
<div class="line">        {</div>
<div class="line">            LogDebug( ( <span class="stringliteral">&quot;Object was a certificate.&quot;</span> ) );</div>
<div class="line">            xClass = CKO_CERTIFICATE;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            LogDebug( ( <span class="stringliteral">&quot;Object handle was invalid.&quot;</span> ) );</div>
<div class="line">            xResult = CKR_OBJECT_HANDLE_INVALID;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>( xResult == CKR_OK )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span>( iAttrib = 0; iAttrib &lt; ulCount; iAttrib++ )</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>( xResult != CKR_OK )</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">switch</span>( pTemplate[ iAttrib ].type )</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">case</span> CKA_CLASS:</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">if</span>( pTemplate[ iAttrib ].pValue == NULL )</div>
<div class="line">                    {</div>
<div class="line">                        pTemplate[ iAttrib ].ulValueLen = <span class="keyword">sizeof</span>( CK_OBJECT_CLASS );</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span>( pTemplate[ iAttrib ].ulValueLen == <span class="keyword">sizeof</span>( CK_OBJECT_CLASS ) )</div>
<div class="line">                        {</div>
<div class="line">                            ( void ) memcpy( pTemplate[ iAttrib ].pValue, &amp;xClass, <span class="keyword">sizeof</span>( CK_OBJECT_CLASS ) );</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                        {</div>
<div class="line">                            LogError( ( <span class="stringliteral">&quot;Failed to parse attribute template. &quot;</span></div>
<div class="line">                                        <span class="stringliteral">&quot;Received a buffer smaller than CK_OBJECT_CLASS.&quot;</span> ) );</div>
<div class="line">                            xResult = CKR_BUFFER_TOO_SMALL;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">case</span> CKA_PUBLIC_KEY_INFO:</div>
<div class="line">                <span class="keywordflow">case</span> CKA_VALUE:</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* See explanation in prvCheckValidSessionAndModule for this exception. */</span></div>
<div class="line">                    <span class="comment">/* coverity[misra_c_2012_rule_10_5_violation] */</span></div>
<div class="line">                    <span class="keywordflow">if</span>( xIsPrivate == ( CK_BBOOL ) CK_TRUE )</div>
<div class="line">                    {</div>
<div class="line">                        pTemplate[ iAttrib ].ulValueLen = CK_UNAVAILABLE_INFORMATION;</div>
<div class="line">                        LogError( ( <span class="stringliteral">&quot;Failed to parse attribute. This data is &quot;</span></div>
<div class="line">                                    <span class="stringliteral">&quot;sensitive and the value will not be returned.&quot;</span> ) );</div>
<div class="line">                        xResult = CKR_ATTRIBUTE_SENSITIVE;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span>( pTemplate[ iAttrib ].pValue == NULL )</div>
<div class="line">                        {</div>
<div class="line">                            pTemplate[ iAttrib ].ulValueLen = ulLength;</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( pTemplate[ iAttrib ].ulValueLen &lt; ulLength )</div>
<div class="line">                        {</div>
<div class="line">                            LogError( ( <span class="stringliteral">&quot;Failed to parse attribute. Buffer was &quot;</span></div>
<div class="line">                                        <span class="stringliteral">&quot;too small to contain data. Expected %lu &quot;</span></div>
<div class="line">                                        <span class="stringliteral">&quot;but got %lu.&quot;</span>,</div>
<div class="line">                                        ( <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> ) ulLength,</div>
<div class="line">                                        ( <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> ) pTemplate[ iAttrib ].ulValueLen ) );</div>
<div class="line">                            xResult = CKR_BUFFER_TOO_SMALL;</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                        {</div>
<div class="line">                            ( void ) memcpy( pTemplate[ iAttrib ].pValue, pxObjectValue, ulLength );</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">case</span> CKA_KEY_TYPE:</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">if</span>( pTemplate[ iAttrib ].pValue == NULL )</div>
<div class="line">                    {</div>
<div class="line">                        pTemplate[ iAttrib ].ulValueLen = <span class="keyword">sizeof</span>( CK_KEY_TYPE );</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( pTemplate[ iAttrib ].ulValueLen &lt; <span class="keyword">sizeof</span>( CK_KEY_TYPE ) )</div>
<div class="line">                    {</div>
<div class="line">                        LogError( ( <span class="stringliteral">&quot;Failed to parse attribute. Expected buffer &quot;</span></div>
<div class="line">                                    <span class="stringliteral">&quot;of size CK_KEY_TYPE.&quot;</span> ) );</div>
<div class="line">                        xResult = CKR_BUFFER_TOO_SMALL;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                        xKeyType = mbedtls_pk_get_type( &amp;xKeyContext );</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordflow">switch</span>( xKeyType )</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordflow">case</span> MBEDTLS_PK_RSA:</div>
<div class="line">                            <span class="keywordflow">case</span> MBEDTLS_PK_RSA_ALT:</div>
<div class="line">                            <span class="keywordflow">case</span> MBEDTLS_PK_RSASSA_PSS:</div>
<div class="line">                                xPkcsKeyType = CKK_RSA;</div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                            <span class="keywordflow">case</span> MBEDTLS_PK_ECKEY:</div>
<div class="line">                            <span class="keywordflow">case</span> MBEDTLS_PK_ECKEY_DH:</div>
<div class="line">                                xPkcsKeyType = CKK_EC;</div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                            <span class="keywordflow">case</span> MBEDTLS_PK_ECDSA:</div>
<div class="line">                                xPkcsKeyType = CKK_ECDSA;</div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                            <span class="keywordflow">default</span>:</div>
<div class="line">                                LogError( ( <span class="stringliteral">&quot;Failed to parse attribute. &quot;</span></div>
<div class="line">                                            <span class="stringliteral">&quot;Could not parse key type.&quot;</span> ) );</div>
<div class="line">                                xResult = CKR_ATTRIBUTE_VALUE_INVALID;</div>
<div class="line">                                <span class="keywordflow">break</span>;</div>
<div class="line">                        }</div>
<div class="line"> </div>
<div class="line">                        ( void ) memcpy( pTemplate[ iAttrib ].pValue, &amp;xPkcsKeyType, <span class="keyword">sizeof</span>( CK_KEY_TYPE ) );</div>
<div class="line">                    }</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">case</span> CKA_PRIVATE_EXPONENT:</div>
<div class="line"> </div>
<div class="line">                    LogError( ( <span class="stringliteral">&quot;Failed to parse attribute. &quot;</span></div>
<div class="line">                                <span class="stringliteral">&quot;CKA_PRIVATE_EXPONENT is private data.&quot;</span> ) );</div>
<div class="line">                    xResult = CKR_ATTRIBUTE_SENSITIVE;</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">case</span> CKA_EC_PARAMS:</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">if</span>( pTemplate[ iAttrib ].pValue == NULL )</div>
<div class="line">                    {</div>
<div class="line">                        pTemplate[ iAttrib ].ulValueLen = <span class="keyword">sizeof</span>( ucP256Oid );</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span>( pTemplate[ iAttrib ].ulValueLen &lt; <span class="keyword">sizeof</span>( ucP256Oid ) )</div>
<div class="line">                        {</div>
<div class="line">                            LogError( ( <span class="stringliteral">&quot;Failed to parse attribute. &quot;</span></div>
<div class="line">                                        <span class="stringliteral">&quot;CKA_EC_PARAMS buffer too small.&quot;</span> ) );</div>
<div class="line">                            xResult = CKR_BUFFER_TOO_SMALL;</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                        {</div>
<div class="line">                            ( void ) memcpy( pTemplate[ iAttrib ].pValue, ucP256Oid, <span class="keyword">sizeof</span>( ucP256Oid ) );</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">case</span> CKA_EC_POINT:</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">if</span>( pTemplate[ iAttrib ].pValue == NULL )</div>
<div class="line">                    {</div>
<div class="line">                        pTemplate[ iAttrib ].ulValueLen = <a class="code" href="group__pkcs11__macros.html#gaed3393d271431bcd27e5017304b03003">pkcs11EC_POINT_LENGTH</a>;</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span>( pTemplate[ iAttrib ].ulValueLen == <a class="code" href="group__pkcs11__macros.html#gaed3393d271431bcd27e5017304b03003">pkcs11EC_POINT_LENGTH</a> )</div>
<div class="line">                        {</div>
<div class="line">                            pxKeyPair = ( mbedtls_ecp_keypair * ) xKeyContext.pk_ctx;</div>
<div class="line">                            *( ( uint8_t * ) pTemplate[ iAttrib ].pValue ) = 0x04; <span class="comment">/* Mark the point as uncompressed. */</span></div>
<div class="line"> </div>
<div class="line">                            <span class="comment">/* Copy xSize value to avoid casting a CK_ULONG size pointer</span></div>
<div class="line"><span class="comment">                             * to a size_t sized pointer. */</span></div>
<div class="line">                            xMbedSize = xSize;</div>
<div class="line">                            lMbedTLSResult = mbedtls_ecp_tls_write_point( &amp;pxKeyPair-&gt;grp,</div>
<div class="line">                                                                          &amp;pxKeyPair-&gt;Q,</div>
<div class="line">                                                                          MBEDTLS_ECP_PF_UNCOMPRESSED,</div>
<div class="line">                                                                          &amp;xMbedSize,</div>
<div class="line">                                                                          ( uint8_t * ) pTemplate[ iAttrib ].pValue + 1,</div>
<div class="line">                                                                          pTemplate[ iAttrib ].ulValueLen - 1UL );</div>
<div class="line">                            xSize = xMbedSize;</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                        {</div>
<div class="line">                            xResult = CKR_BUFFER_TOO_SMALL;</div>
<div class="line">                        }</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordflow">if</span>( ( xResult == CKR_OK ) &amp;&amp; ( lMbedTLSResult &lt; 0 ) )</div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordflow">if</span>( lMbedTLSResult == MBEDTLS_ERR_ECP_BUFFER_TOO_SMALL )</div>
<div class="line">                            {</div>
<div class="line">                                LogError( ( <span class="stringliteral">&quot;Failed to extract EC point. &quot;</span></div>
<div class="line">                                            <span class="stringliteral">&quot;CKA_EC_POINT buffer was too small.&quot;</span> ) );</div>
<div class="line">                                xResult = CKR_BUFFER_TOO_SMALL;</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">else</span></div>
<div class="line">                            {</div>
<div class="line">                                LogError( ( <span class="stringliteral">&quot;Failed to extract EC point. &quot;</span></div>
<div class="line">                                            <span class="stringliteral">&quot;mbedtls_ecp_tls_write_point failed: &quot;</span></div>
<div class="line">                                            <span class="stringliteral">&quot;mbed TLS error = %s : %s.&quot;</span>,</div>
<div class="line">                                            <a class="code" href="core__pkcs11__mbedtls_8c.html#a92427274c3174ef89fbf82a0ad25a252">mbedtlsHighLevelCodeOrDefault</a>( lMbedTLSResult ),</div>
<div class="line">                                            <a class="code" href="core__pkcs11__mbedtls_8c.html#a1936e3a07702240561149805e8f0bfbb">mbedtlsLowLevelCodeOrDefault</a>( lMbedTLSResult ) ) );</div>
<div class="line">                                xResult = CKR_FUNCTION_FAILED;</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                        {</div>
<div class="line">                            pTemplate[ iAttrib ].ulValueLen = xSize + 1UL;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line"> </div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                    LogError( ( <span class="stringliteral">&quot;Failed to parse attribute. Received unknown &quot;</span></div>
<div class="line">                                <span class="stringliteral">&quot;attribute type.&quot;</span> ) );</div>
<div class="line">                    xResult = CKR_ATTRIBUTE_TYPE_INVALID;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Free the buffer where object was stored. */</span></div>
<div class="line">        <a class="code" href="core__pkcs11__pal_8h.html#a62b94691f4534e5328eb88362244e308">PKCS11_PAL_GetObjectValueCleanup</a>( pxObjectValue, ulLength );</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Free the mbedTLS structure used to parse the key. */</span></div>
<div class="line">        mbedtls_pk_free( &amp;xKeyContext );</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Free the mbedTLS structure used to parse the certificate. */</span></div>
<div class="line">        mbedtls_x509_crt_free( &amp;xMbedX509Context );</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> xResult;</div>
<div class="line">}</div>
<div class="ttc" id="acore__pkcs11_8h_html_a30315d302108bcfb354196f37b16a492"><div class="ttname"><a href="core__pkcs11_8h.html#a30315d302108bcfb354196f37b16a492">CK_DECLARE_FUNCTION</a></div><div class="ttdeci">#define CK_DECLARE_FUNCTION(returnType, name)</div><div class="ttdoc">Macro for defining a PKCS #11 functions.</div><div class="ttdef"><b>Definition:</b> core_pkcs11.h:72</div></div>
<div class="ttc" id="acore__pkcs11_8h_html_a61aab65f40f1865cfcdbb66aab3c9ffa"><div class="ttname"><a href="core__pkcs11_8h.html#a61aab65f40f1865cfcdbb66aab3c9ffa">pkcs11DER_ENCODED_OID_P256</a></div><div class="ttdeci">#define pkcs11DER_ENCODED_OID_P256</div><div class="ttdoc">OID for curve P-256.</div><div class="ttdef"><b>Definition:</b> core_pkcs11.h:153</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_a1936e3a07702240561149805e8f0bfbb"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#a1936e3a07702240561149805e8f0bfbb">mbedtlsLowLevelCodeOrDefault</a></div><div class="ttdeci">#define mbedtlsLowLevelCodeOrDefault(mbedTlsCode)</div><div class="ttdoc">Utility for converting the level-level code in an mbedTLS error to string, if the code-contains a lev...</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:93</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_a8a3079aa3ce5d51bb787a3e661714ef0"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#a8a3079aa3ce5d51bb787a3e661714ef0">prvSessionPointerFromHandle</a></div><div class="ttdeci">static P11Session_t * prvSessionPointerFromHandle(CK_SESSION_HANDLE xSession)</div><div class="ttdoc">Maps an opaque caller session handle into its internal state structure.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:346</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_a92427274c3174ef89fbf82a0ad25a252"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#a92427274c3174ef89fbf82a0ad25a252">mbedtlsHighLevelCodeOrDefault</a></div><div class="ttdeci">#define mbedtlsHighLevelCodeOrDefault(mbedTlsCode)</div><div class="ttdoc">Utility for converting the high-level code in an mbedTLS error to string, if the code-contains a high...</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:85</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_aaad61dc7b2313286bdd049676ef0fd70"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#aaad61dc7b2313286bdd049676ef0fd70">C_GetAttributeValue</a></div><div class="ttdeci">CK_RV C_GetAttributeValue(CK_SESSION_HANDLE hSession, CK_OBJECT_HANDLE hObject, CK_ATTRIBUTE_PTR pTemplate, CK_ULONG ulCount)</div><div class="ttdoc">Obtains an attribute value of an object.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:2638</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_aadf1ee4b99279af65de44082fbd4de52"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#aadf1ee4b99279af65de44082fbd4de52">prvFindObjectInListByHandle</a></div><div class="ttdeci">static void prvFindObjectInListByHandle(CK_OBJECT_HANDLE xAppHandle, CK_OBJECT_HANDLE_PTR pxPalHandle, CK_BYTE_PTR *ppcLabel, CK_ULONG_PTR pxLabelLength)</div><div class="ttdoc">Looks up a PKCS #11 object's label and PAL handle given an application handle.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:1051</div></div>
<div class="ttc" id="acore__pkcs11__mbedtls_8c_html_ab93c9263b9b89774e57eee9e8ac708a8"><div class="ttname"><a href="core__pkcs11__mbedtls_8c.html#ab93c9263b9b89774e57eee9e8ac708a8">prvCheckValidSessionAndModule</a></div><div class="ttdeci">static CK_RV prvCheckValidSessionAndModule(const P11Session_t *pxSession)</div><div class="ttdoc">Helper to check if the current session is initialized and valid.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:304</div></div>
<div class="ttc" id="acore__pkcs11__pal_8h_html_a5f9deac2fdf2dc0ac52e87f95d3d6fb6"><div class="ttname"><a href="core__pkcs11__pal_8h.html#a5f9deac2fdf2dc0ac52e87f95d3d6fb6">PKCS11_PAL_GetObjectValue</a></div><div class="ttdeci">CK_RV PKCS11_PAL_GetObjectValue(CK_OBJECT_HANDLE xHandle, CK_BYTE_PTR *ppucData, CK_ULONG_PTR pulDataSize, CK_BBOOL *pIsPrivate)</div><div class="ttdoc">Gets the value of an object in storage, by handle.</div></div>
<div class="ttc" id="acore__pkcs11__pal_8h_html_a62b94691f4534e5328eb88362244e308"><div class="ttname"><a href="core__pkcs11__pal_8h.html#a62b94691f4534e5328eb88362244e308">PKCS11_PAL_GetObjectValueCleanup</a></div><div class="ttdeci">void PKCS11_PAL_GetObjectValueCleanup(CK_BYTE_PTR pucData, CK_ULONG ulDataSize)</div><div class="ttdoc">Cleanup after PKCS11_GetObjectValue().</div></div>
<div class="ttc" id="agroup__pkcs11__macros_html_gaed3393d271431bcd27e5017304b03003"><div class="ttname"><a href="group__pkcs11__macros.html#gaed3393d271431bcd27e5017304b03003">pkcs11EC_POINT_LENGTH</a></div><div class="ttdeci">#define pkcs11EC_POINT_LENGTH</div><div class="ttdoc">Length of bytes to contain an EC point.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:168</div></div>
<div class="ttc" id="astruct_p11_session__t_html"><div class="ttname"><a href="struct_p11_session__t.html">P11Session_t</a></div><div class="ttdoc">Session structure.</div><div class="ttdef"><b>Definition:</b> core_pkcs11_mbedtls.c:271</div></div>
</div><!-- fragment --> <dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">hSession</td><td>Handle of a valid PKCS #11 session. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">hObject</td><td>PKCS #11 object handle to be queried. </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">pTemplate</td><td>Attribute template. pxTemplate.pValue should be set to the attribute to be queried. pxTemplate.ulValueLen should be set to the length of the buffer allocated at pxTemplate.pValue, and will be updated to contain the actual length of the data copied. pxTemplate.pValue should be set to point to a buffer to receive the attribute value data. If parameter length is unknown, pxTemplate.pValue may be set to NULL, and this function will set the required buffer length in pxTemplate.ulValueLen. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ulCount</td><td>The number of attributes in the template.</td></tr>
  </table>
  </dd>
</dl>
<table class="doxtable">
<tr>
<th>Object Type </th><th>Queryable Attributes </th></tr>
<tr>
<td rowspan="2">Certificate</td><td>CKA_CLASS </td></tr>
<tr>
<td>CKA_VALUE </td></tr>
<tr>
<td rowspan="3">EC Private Key</td><td>CKA_CLASS </td></tr>
<tr>
<td>CKA_KEY_TYPE </td></tr>
<tr>
<td>CKA_EC_PARAMS </td></tr>
<tr>
<td rowspan="4">EC Public Key</td><td>CKA_CLASS </td></tr>
<tr>
<td>CKA_KEY_TYPE </td></tr>
<tr>
<td>CKA_EC_PARAMS </td></tr>
<tr>
<td>CKA_EC_POINT </td></tr>
<tr>
<td rowspan="2">RSA Private Key</td><td>CKA_CLASS </td></tr>
<tr>
<td>CKA_KEY_TYPE </td></tr>
<tr>
<td rowspan="2">RSA Public Key</td><td>CKA_CLASS </td></tr>
<tr>
<td>CKA_KEY_TYPE </td></tr>
</table>
<dl class="section return"><dt>Returns</dt><dd>CKR_OK if successful. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
